# Cache

## cache的工作原理

基本的`cache`一项至少包含数据信息以及标记位

现代体系结构中的`cache`多采用组相联,多级`cache`结构

为方便起见以下使用一级`cache`说明,多级就等价于将低级`cache`看做是高级`cache`的高速缓存

1. 通过地址获得在`cache`中的索引
2. 由索引得到`cache`中的一组,比较该组中各项的标记是否与给出地址符合
3. 比较后 :
   * 若存在符合,则`cache`命中,返回得到的物理内存中的数据值
   * 若不存在符合,**则产生缺失,这时需要到内存中(实际上一般是下一级`cache`)中寻找该地址对应的数据,并将该数据写到`cache`中来**

![](cache结构/cache-work.png)

注 : 在`cache`使用实际中涉及缺失时的替换策略,写时的数据一致性等等工程细节问题,此处只做简单说明

* 替换策略 : 随机替换,最近最少使用策略,先进先出策略

  **在考虑策略时要注意硬件实现的复杂性**

* 写操作一致性 : 

  * 写回法 : 暂时只向`cache`中写入,并标记是否修改,直到该块被替换出去才将值写会内存中
  * 写直达 : 在每次写`cache`的同时也写入内存中

## cache结构种类

### VIVT

`Virtual index Virtual Tag` : 使用虚拟地址索引域和虚拟地址的标记位,其中存储的是其对应物理内存的数据值

* 优势 :

  直接使用CPU发出的虚拟地址的索引域和标记域来查找`cache line`,而不用经过`MMU`的翻译,所以查找的速度是最快的

* 问题 :

  * `synonyms` : 多个不同的虚拟地址可能会被映射到同一个物理地址,即缓存别名情况
    1. 例如在多进程通信时,多个虚拟地址映射到一个物理地址,导致**同一个物理地址有多个高速缓存**,对任何一个缓存的修改都会导致数据不一致
  * `homonyms` : 相同的虚拟地址指向不同的物理地址,**这种情况下仅仅依靠`Virtual Index`无法区分这些相同的`cache`项**
    1. 在不同的进程中可能出现该情况

### VIPT

`Virtual Index Physical Tag`：使用虚拟地址的索引域和物理地址的标记域,其中存储在内存中物理地址的数据值,**这种方法综合较优**

* 优势 :

  **可以通过一定程度的并行设计来提高访存效率**

  1. `CPU`指令给出虚拟地址 :

     * 虚拟地址进入`cache`结构寻找对应的组

     * 虚拟地址进入`TLB`结构查询是否有对应的物理页号生成物理地址

  2. 得到物理地址后作为生成`tag`访问对应的缓存项

  3. 检查是否命中 :

     * 命中则返回数据
     * 没有命中则根据物理地址访问内存

* 问题解决 :

  * 显然,由于是通过物理地址的标记位来确定是否命中的,所以不存在相同的虚拟地址指向不同物理地址的情况

  * 对于`synonyms`问题 :

    把握一点 : **虚实地址的映射关系是通过页结构完成的,即页对齐思想**

    以4KB大小为一页来分析 :

    1. **相互对应的虚拟和物理地址的页内偏移一定相同,即低12位一定相同**
    2. 当多个虚拟地址映射到同一个物理地址时,这些虚拟地址的低12位一定是相同的
    3. 只要项内偏移 + `cache`索引没有超过12位,则这些虚拟地址对应同一个`cache`组,而物理标记位一定是唯一的,所以对应同一项
    4. 所以不会出现缓存别名情况

### PIPT

`Physical Index Physical Tag`：使用物理地址的索引域和物理地址的标记域

**问题在于访存太慢**

1. `CPU`给出虚拟地址来访问数据，`TLB`接收到这个地址之后查找是否有对应的页表项。
2. 假设页表项存在，则根据物理地址在`cache`中查询；如果不存在，则`MMU`执行正常的页表查询工作之后再根据物理地址在`cache`中查询，同时更新`TLB`中的内容。
3. 如果`cache`命中，则直接返回给`CPU`数据；如果没有命中则按照相应的算法进行cache`的替换或者装填，之后返回给`CPU`数据。

**当`TLB`没用命中但是这个地址是在`cache`中时会带来巨大的性能损失**

![](cache结构/PIPT.png)

## cache + TLB 工作

![](cache结构/cache+TLB.png)

